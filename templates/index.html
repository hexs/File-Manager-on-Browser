<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Explorer</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<header>
    <form method="post" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
        <input type="file" name="file" id="file-upload">
        <input type="hidden" name="current_path" value="{{ current_path }}">
        <input type="submit" value="Upload" class="btn">
        <button type="button" id="create-file-btn" class="btn">Create file</button>
        <button type="button" id="create-folder-btn" class="btn">Create folder</button>
    </form>
    {{ current_path }}
</header>
<div class="main-content">
    <h3>Directories:</h3>
    <ul id="directory-list">
        {% if current_path %}
            <li><a href="{{ url_for('index', subpath='/'.join(current_path.split('/')[:-1])) }}">..</a></li>
        {% endif %}
        {% for directory in directories %}
            <li><a href="{{ url_for('index', subpath=current_path + '/' + directory) }}"
                   data-path="{{ current_path + '/' + directory }}">{{ directory }}</a></li>
        {% endfor %}
    </ul>
    <h3>Files:</h3>
    <ul id="file-list">
        {% for file in files %}
            <li><a href="{{ url_for('index', subpath=current_path + '/' + file) }}"
                   data-path="{{ current_path + '/' + file }}">{{ file }}</a></li>
        {% endfor %}
    </ul>
</div>
<div id="context-menu" class="context-menu">
    <ul>
        <li id="download-option">Download</li>
        <li id="rename-option">Rename</li>
        <li id="delete-option">Delete</li>
        <li id="edit-option">Edit</li>
        <li id="extract-option">Extract</li>
    </ul>
</div>
<div id="edit-modal">
    <div class="modal-content">
        <label for="file-name">File name:</label>
        <input type="text" id="file-name">
        <textarea id="edit-content"></textarea>
        <div class="btn-container">
            <button id="save-edit" class="btn">Save</button>
            <button id="cancel-edit" class="btn">Cancel</button>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let selectedItem = null;
        let isNewFile = false;

        function createFolder() {
            const folderName = prompt('Enter folder name:');
            if (folderName) {
                const path = '{{ current_path }}/' + folderName;
                $.post('/create_folder', {path: path})
                    .done(function (data) {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to create folder');
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        alert(`Failed to create folder: ${errorThrown}`);
                    });
            }
        }

        function createFile() {
            isNewFile = true;
            $('#file-name').val('');
            $('#edit-content').val('');
            $('#edit-modal').show();
        }

        function editFile() {
            isNewFile = false;
            const path = selectedItem.data('path');
            const fileName = path.split('/').pop();
            $('#file-name').val(fileName);
            $.get(`/edit?path=${encodeURIComponent(path)}`)
                .done(function (data) {
                    if (data.success) {
                        $('#edit-content').val(data.content);
                        $('#edit-modal').show();
                    } else {
                        alert('Failed to load file content');
                    }
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    alert(`Failed to load file: ${errorThrown}`);
                });
        }

        function saveEdit() {
            const fileName = $('#file-name').val();
            const content = $('#edit-content').val();
            let path;

            if (isNewFile) {
                path = '{{ current_path }}/' + fileName;
            } else {
                const oldPath = selectedItem.data('path');
                const directory = oldPath.substring(0, oldPath.lastIndexOf('/') + 1);
                path = directory + fileName;
            }

            $.post(`/edit?path=${encodeURIComponent(path)}`, {content: content})
                .done(function (data) {
                    if (data.success) {
                        $('#edit-modal').hide();
                        alert('File saved successfully');
                        location.reload();
                    } else {
                        alert('Failed to save file');
                    }
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    alert(`Failed to save file: ${errorThrown}`);
                });
        }


        function showContextMenu(e, target) {
            e.preventDefault();
            selectedItem = $(target);
            $('#context-menu').css({
                display: 'block',
                left: e.pageX,
                top: e.pageY
            });
            updateContextMenu(target);
        }

        function hideContextMenu() {
            $('#context-menu').hide();
        }

        function updateContextMenu(target) {
            const path = $(target).data('path');
            const isTextFile = path.match(/\.(txt|md|js|py|html|css|json|xml|csv|log|gitignore)$/i);
            const isZipFile = path.endsWith('.zip');
            $('#edit-option').toggle(isTextFile !== null);
            $('#extract-option').toggle(isZipFile);
        }

        function downloadItem() {
            const path = selectedItem.data('path');
            window.location.href = `/download?path=${encodeURIComponent(path)}`;
        }

        function renameItem() {
            const newName = prompt('Enter new name:');
            if (newName) {
                const oldPath = selectedItem.data('path');
                const newPath = oldPath.substring(0, oldPath.lastIndexOf('/') + 1) + newName;
                $.post('/rename', {old_path: oldPath, new_path: newPath})
                    .done(function () {
                        location.reload();
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        alert(`Failed to rename: ${errorThrown}`);
                    });
            }
        }

        function deleteItem() {
            if (confirm('Are you sure you want to delete this item?')) {
                $.post('/delete', {path: selectedItem.data('path')})
                    .done(function () {
                        location.reload();
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        alert(`Failed to delete: ${errorThrown}`);
                    });
            }
        }

        function extractFile() {
            const path = selectedItem.data('path');
            const folderName = prompt('Enter a folder name for extraction:');
            $.post('/extract_file', {path: path, folder_name: folderName})
                .done(function (data) {
                    if (data.success) {
                        alert('File extracted successfully');
                        location.reload();
                    } else {
                        alert('Failed to extract file: ' + data.error);
                    }
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    alert(`Failed to extract file: ${errorThrown}`);
                });
        }


        $('#directory-list, #file-list').on('contextmenu', 'a', function (e) {
            showContextMenu(e, this);
        });

        $(document).on('click', hideContextMenu);

        $('#download-option').click(downloadItem);
        $('#rename-option').click(renameItem);
        $('#delete-option').click(deleteItem);
        $('#edit-option').click(editFile);
        $('#extract-option').click(extractFile);

        $('#create-folder-btn').click(createFolder);
        $('#create-file-btn').click(createFile);
        $('#save-edit').click(saveEdit);
        $('#cancel-edit').click(function () {
            $('#edit-modal').hide();
        });

        // Prevent default behavior for file drag and drop
        $(document).on('drag dragstart dragend dragover dragenter dragleave drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        // Handle file drop
        $(document).on('drop', function (e) {
            let droppedFiles = e.originalEvent.dataTransfer.files;
            $('#file-upload').prop('files', droppedFiles);
        });
    });
</script>
</body>
</html>